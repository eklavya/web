{"componentChunkName":"component---src-templates-post-template-js","path":"/posts/deeply-nested-ifs-combine-functions","result":{"data":{"markdownRemark":{"id":"579d778c-7196-5535-bda5-674b3be14f83","html":"<p>Update: I didn’t know about monads and functional programming at this point :D</p>\n<p>I was looking for a way to get rid of nasty deeply nested ifs in one of rather large functions in a codebase. This function was particularly notorious and would result in bugs and broken things everytime there was a change in it. The reason was simple, the real story lost in a mess of condition checks.</p>\n<p>I thought there has to be a better way and I found one (hopefully).</p>\n<p>I came up with this idea that the functions should be combined and the errors should short circuit the computation and return with helpful message of what went wrong. Usually it would be something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>check1<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>check2<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">//...more checks {</span>\n        doSomething<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        sendOk\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    \tsendError2\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    sendError1<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This happens specially in case of a web application (play app in my case).\nYou can not really get rid of the nesting without resorting to returns.\nIf you use returns it becomes - </p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>check1<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> error\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>check2<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> error\n<span class=\"token punctuation\">}</span>\ndoSomething<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">return</span> ok</code></pre></div>\n<p>But this suffers from the same problem that changes are hard and the logic\nand flow are hidden behind the net of condition checks.</p>\n<p>We can do a lot better by using awesome scala implicits and some functional goodness.</p>\n<p>First we define a combinable implicit view of functions to enable cmobining them with ~.</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">implicit</span> <span class=\"token keyword\">class</span> Combinable<span class=\"token punctuation\">[</span>A<span class=\"token punctuation\">,</span> B<span class=\"token punctuation\">,</span> C<span class=\"token punctuation\">,</span> D<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span>f<span class=\"token operator\">:</span> Function1<span class=\"token punctuation\">[</span>A<span class=\"token punctuation\">,</span> Either<span class=\"token punctuation\">[</span>B<span class=\"token punctuation\">,</span> C<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">def</span> <span class=\"token operator\">~</span><span class=\"token punctuation\">(</span>g<span class=\"token operator\">:</span> Function1<span class=\"token punctuation\">[</span>Either<span class=\"token punctuation\">[</span>B<span class=\"token punctuation\">,</span> C<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> Either<span class=\"token punctuation\">[</span>B<span class=\"token punctuation\">,</span> D<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Function1<span class=\"token punctuation\">[</span>A<span class=\"token punctuation\">,</span> Either<span class=\"token punctuation\">[</span>B<span class=\"token punctuation\">,</span> D<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> \n        x<span class=\"token operator\">:</span> A <span class=\"token keyword\">=></span>\n            <span class=\"token keyword\">val</span> v <span class=\"token operator\">=</span> f<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">.</span>isLeft<span class=\"token punctuation\">)</span> Left<span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">.</span>left<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">else</span> g<span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Notice how we do not proceed farther than the first error and return it as the result.</p>\n<p>Now all are functions <code class=\"language-text\">Function1[A, B]</code> are combinable given they consume an Either\nand produce an Either and a function f is combined with another function g\nsuch that f’s result can be consumed by g, which is usually the case.</p>\n<p>Now just define your checks as different functions. So for example in a play app -</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">def</span> foo<span class=\"token punctuation\">(</span>fooIn<span class=\"token operator\">:</span> Either<span class=\"token punctuation\">[</span>Result<span class=\"token punctuation\">,</span> <span class=\"token builtin\">String</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    fu<span class=\"token punctuation\">(</span>fooIn<span class=\"token punctuation\">)</span> <span class=\"token keyword\">match</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> None <span class=\"token keyword\">=></span> Left<span class=\"token punctuation\">(</span>BadRequest<span class=\"token punctuation\">(</span><span class=\"token string\">\"fu required\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">case</span> Some<span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">)</span> <span class=\"token keyword\">=></span> Right<span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">def</span> bar<span class=\"token punctuation\">(</span>barIn<span class=\"token operator\">:</span> Either<span class=\"token punctuation\">[</span>Result<span class=\"token punctuation\">,</span> Token<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">val</span> b <span class=\"token operator\">=</span> barIn<span class=\"token punctuation\">.</span>right<span class=\"token punctuation\">.</span>get\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>check<span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        Left<span class=\"token punctuation\">(</span>BadRequest<span class=\"token punctuation\">(</span><span class=\"token string\">\"bar error\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        Right<span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">//... and so on</span></code></pre></div>\n<p>And our main function becomes -</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">def</span> makeFoo <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">val</span> f <span class=\"token operator\">=</span> foo <span class=\"token operator\">~</span> bar <span class=\"token operator\">~</span> baz <span class=\"token comment\">// and so on</span>\n    f<span class=\"token punctuation\">(</span>someIn<span class=\"token punctuation\">)</span> <span class=\"token keyword\">match</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> Left<span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token keyword\">=></span> e\n        <span class=\"token keyword\">case</span> Right<span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">)</span> <span class=\"token keyword\">=></span> f\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Much easier to understand what is going on and much easier to add a new check. I think it might already be well known and\nan established practice (much better than mine) but I couldn’t look it up so I blogged about it.</p>\n<p>Thanks for reading, happy coding :)</p>","fields":{"slug":"/posts/deeply-nested-ifs-combine-functions","tagSlugs":["/tag/scala/","/tag/functional-programming/"]},"frontmatter":{"date":"2014-08-08T00:00:00.000Z","description":"","tags":["Scala","Functional Programming"],"title":"Deeply nested ifs? Combine functions","socialImage":""}}},"pageContext":{"slug":"/posts/deeply-nested-ifs-combine-functions"}},"staticQueryHashes":["251939775","3439816877","401334301"]}